---
title: "Report"
output: 
  html_document:
    theme: flatly
    toc: true
    code_folding: hide
    toc_float: true
---

<style>
body {
  color: #382320 !important;    
}

h1, h2, h3, h4, h5 {
  color: #382320 !important;     
}
</style>

<div class="body-overlay"></div>

<div class="main-container">

<link href="https://fonts.googleapis.com/css2?family=Kranky&display=swap" rel="stylesheet">

<style>
.rat-title {
  font-family: 'Kranky', cursive;
  font-size: 46px;
  font-weight: 400;
  color: #333333;
  letter-spacing: 1px;
  margin-top: 10px;
  margin-bottom: 14px;
}
</style>

<style>
body {
  background-image: url("images/proposal_bg.jpg");
  background-size: cover;
  background-attachment: fixed;
  background-position: center;
  background-repeat: no-repeat;
  opacity: 1;
}

.body-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 190%;    
  height: 120%;   
  background: rgba(255,255,255,0.05); 
  z-index: -1;    
  pointer-events: none;
}

.main-container {
  background: rgba(255,255,255,0.75);
  padding: 20px;
  border-radius: 12px;
}
</style>

<h1 class="rat-title">Report</h1>

## Motivation

New York City is well-known for its rodent challenges, and rat sightings have continued to increase in recent years. At the same time, restaurant sanitation is a key part of the city’s environmental health system. We wanted to understand whether these two issues are connected: Do poor restaurant conditions contribute to higher rat activity in surrounding neighborhoods?

Because rats, food waste, and human activity all interact at the neighborhood level, exploring this relationship can offer insights for targeted public health and sanitation strategies.

## Related Work

Our project was inspired by several sources.
NYC Open Data provides large, publicly accessible datasets related to 311 rat complaints and DOHMH restaurant inspections. Prior studies and news reports have described seasonal patterns in rat sightings and highlighted sanitation as a contributing factor, but few have merged these datasets to look at neighborhood-level associations.

Spatial epidemiology tools, such as hotspot detection and neighborhood clustering, also informed our approach, as this type of analysis is commonly used to study environmental and health disparities.

## Initial Questions 

We began with three main questions:

1. Are rat sightings higher in neighborhoods with worse restaurant sanitation?

2. Do rat sightings follow seasonal trends over time?

3. Are there clear spatial hotspots of rats and violations across NYC?

As we started cleaning and exploring the data, the project naturally expanded. We realized that socioeconomic factors such as poverty and population density showed strong patterns across neighborhoods, so we added the question:

4. How do SES conditions shape both rat activity and violation patterns?

During modeling, we also saw evidence of possible reverse causality (higher rat activity could lead to stricter inspections), so we introduced a lagged exposure variable:

5. Does the previous month’s restaurant violation rate predict current rat sightings?

This became one of the key components of our final analysis.



## Data

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(readr)
library(janitor)
library(dplyr)
library(ggplot2)
library(readxl)
library(sf)
library(spdep)
library(tigris)
library(lubridate)
```


We integrated and merged three datasets for our analysis: **Rat Sighting**, **NYC Restaurant Inspection Result**,and **ACS 2019 5-year estimates**. To ensure temporal consistency and spatial alignment across datasets, the following steps were applied.


_Notice: For the merged data and its cleaning process, we didn't include `longitude` and `latitude` because they are not able to be merged on zipcode x year x month level. We left them for Spatial Analysis specifically. For **all** 3 datasets, only records with ZIP codes 10001–11697 were included (notice that NYC zip codes are not cumulative so only zipcodes in this range+overlaps between 3 datasets). For **Rat Sighting** and **NYC Restaurant Inspection Result** datasets, records with dates between 2019-01-01 and 2024-12-31 were included._

```{r,message=FALSE, warning = FALSE}

rats_clean_2019_2024 <- read_csv(
  "data/Rat_Sightings_20251106.csv",
  na = c("NA", "", "0")
) |>
  janitor::clean_names() |>
  # covert datetime to example: "2024-12-31 18:15:58"
  mutate(
    created_datetime = lubridate::parse_date_time(
      created_date,
      orders = "Y b d I:M:S p",
      tz = "America/New_York"
    ),
    created_date_only = as.Date(created_datetime)
  ) |>
  # filter: 2019–2024 and zipcodes 10001-11697
  filter(
    !is.na(created_datetime),
    created_date_only >= as.Date("2019-01-01"),
    created_date_only <= as.Date("2024-12-31")
  ) |>
  mutate(
    incident_zip = incident_zip |>
      as.character() |>
      stringr::str_extract("\\d+") |>
      stringr::str_pad(width = 5, side = "left", pad = "0")
  ) |>
  filter(
    incident_zip >= "10001",
    incident_zip <= "11697"
  ) |>
  dplyr::select(
    dplyr::any_of(c(
      "unique_key", 
      "created_date_only",
      "complaint_type", 
      "descriptor", 
      "status", 
      "resolution_action_updated_date", 
      "location_type", 
      "incident_zip",
      "incident_address", 
      "street_name", 
      "cross_street_1", 
      "cross_street_2", 
      "city", 
      "borough",
      "latitude",
      "longitude",
      "community_board", 
      "council_district", 
      "census_tract", 
      "nta" 
    ))
  ) |>
  # keep for spatial analysis
  filter(
    !is.na(incident_zip),
    !is.na(latitude),
    !is.na(longitude)
  ) |>
  # standardize zipcode, year, and month
  mutate(
    zipcode = incident_zip,
    year    = lubridate::year(created_date_only),
    month   = lubridate::month(created_date_only)
  )

```

## Data Source 1

**[Rat Sighting](https://data.cityofnewyork.us/Social-Services/Rat-Sightings/3q43-55fe/about_data)**: Each row represents one rat sighting report based on the [311 Service Requests](https://data.cityofnewyork.us/Social-Services/311-Service-Requests-from-2010-to-Present/erm2-nwe9/about_data). Key raw fields include complaint date, exact address, borough, zipcodes, and geographic coordinates.

**Data Pre-cleaning steps included:**

- Converted raw timestamps `created_date_only` into standardized datetime (yyyy-mm-dd), then create new variables `year` and `month`.

- Extracted valid 5-digit NYC ZIP codes (10001–11697) `incident_zip`, then create new variable `zipcode`.

- Filtered to observations from 2019-01-01 to 2024-12-31.

- Removed records missing ZIP or geolocation (required for spatial EDA), and keep variables `longitude` and `latitude` for future **Spatial Analysis**.

- We were not interested in all variables of the raw dataset, so we selected for merged data: 

`unique_key`: unique ID represents a single rat sighting report.

`created_date_only`: date of the complaint created without exact time.

`zipcode`: zip codes of the rat sighting complaints.

`year`: year of the rat sighting complaints.

`month`: month of the rat sighting complaints.

`latitude`: the latitude of the specific rat sighting.

`longitude`: the longitude of the specific rat sighting.

```{r,message=FALSE, warning = FALSE}
rat_agg_zip_month_full <- rats_clean_2019_2024 |>
  group_by(zipcode, year, month) |>
  summarize(
    rat_count_zip_month = n_distinct(unique_key),
    .groups = "drop"
  ) |>
  complete(
    zipcode,
    year,
    month,
    fill = list(rat_count_zip_month = 0)
  )
```

**Aggregate Rat Sighting by zip x year x month**, then create a new variable `rat_count_zip_month`: total numbers of rat sightings count of a specific zip by year by month.


```{r,message=FALSE, warning = FALSE}
inspections_clean <- read_csv(
  "data/DOHMH_New_York_City_Restaurant_Inspection_Results.csv",
  na = c("NA", "", "0")
) |>
  clean_names() |>
  remove_empty(c("rows", "cols")) |>
  
  # Standardize ZIP and Dates
  mutate(
    zipcode = zipcode |>
      as.character() |>
      str_extract("\\d{5}") |>   # ensure 5-digit format
      str_pad(width = 5, pad = "0"),
    date = mdy(inspection_date)
  ) |>
  
  # Filter valid records
  filter(
    !is.na(date),
    date >= as.Date("2019-01-01"),
    date <= as.Date("2024-12-31"),

    !is.na(zipcode),
    zipcode >= "10001",
    zipcode <= "11697",

    !is.na(latitude),
    !is.na(longitude),
    !is.na(boro),
    !is.na(violation_code)   # keep only violation records
  ) |>
  
  # Select necessary variables
  dplyr::select(
    restaurant_id = camis,
    dba,
    borough = boro,
    zipcode,
    cuisine_description,
    date,
    action,
    violation_code, violation_description, critical_flag,
    score, grade, grade_date, record_date,
    inspection_type,
    latitude, longitude
  ) |>
  
  # Add Year and Month
  mutate(
    year = year(date),
    month = month(date)
  )
```
## Data Source 2

**[NYC Restaurant Inspection Result](https://data.cityofnewyork.us/Health/DOHMH-New-York-City-Restaurant-Inspection-Results/43nn-pn8j/about_data)**: We utilized the NYC Restaurant Inspection Results dataset obtained from NYC Open Data, which compiles sanitation inspection outcomes for food service establishments across New York City. The dataset contains restaurant-level violation records including location, inspection dates, cuisine type, violation codes, and inspection results issued by the Department of Health and Mental Hygiene (DOHMH). This dataset provides an indicator of environmental hygiene conditions that may influence rodent activity.

**Data Pre-cleaning steps included:**
- Extracted valid 5-digit NYC ZIP codes (10001–11697) `zipcode` and padded to valid 5-digit format.

-Raw inspection dates `inspection_date` converted to standardized Date format. Extracted `year` and `month` for temporal trend analysis.

- Retained only observations with non-missing `violation_code`. Inspections showing “No violations observed” were excluded. Removed incomplete geographic records lacking `latitude`/`longitude` or borough values.

- We were not interested in all variables of the raw dataset, so we selected for merged data: 

`restaurant_id`: unique ID of each restaurants.

`zipcode`: zip codes of restaurants.

`year`: year of the Restaurant Inspection and Violations Results.

`month`: month of the Restaurant Inspection and Violations Results.

`latitude`: the latitude of the Restaurants.

`longitude`: the longitude of the Restaurants.



```{r,message=FALSE, warning = FALSE}
restaurant_agg_zip_month_full <- inspections_clean |>
  group_by(zipcode, year, month) |>
  summarise(
    violation_count_zip_month = n(),
    inspection_count_zip_month = n_distinct(restaurant_id, date),
    .groups = "drop"
  ) |>
 complete(
    zipcode,
    year  = 2019:2024,
    month = 1:12,
    fill = list(
      violation_count_zip_month   = 0,
      inspection_count_zip_month = 0
    )
  )
```
**Aggregate NYC Restaurant Inspection Results by zip x year x month**, then create new variables:
`violation_count_zip_month` (total number of recorded violations within each ZIP–year–month) and `inspection_count_zip_month`(total number of recorded inspections within each ZIP–year–month).


```{r,message=FALSE, warning = FALSE}
library(tidycensus)
library(tidyverse)

acs_zip_raw <- get_acs(
  geography = "zip code tabulation area",
  variables = c(
    total_pop   = "B01003_001",
    pov_total   = "B17001_001",
    pov_count   = "B17001_002",
    med_income  = "B19013_001"
  ),
  year   = 2019,
  survey = "acs5",
  geometry = FALSE
)

ses_zip <- acs_zip_raw %>%
  select(GEOID, variable, estimate) %>%
  pivot_wider(
    names_from  = variable,
    values_from = estimate
  ) %>%
  mutate(
    zip = GEOID,
    poverty_rate = pov_count / pov_total,
    population_density = total_pop / 1000,
    median_household_income = med_income / 1000
  )

ses_zip_nyc <- ses_zip %>%
  mutate(zip_num = as.numeric(zip)) %>%
  filter(
    !is.na(zip_num),
    zip_num >= 10001,
    zip_num <= 11697,
    total_pop > 0,
    pov_total > 0
  ) %>%
  select(
    zipcode  = zip_num,
    total_pop,
    poverty_rate,
    population_density,
    median_household_income
  )
```

## Data Source 3

**ACS 2019 5-year estimates**: Area-level socioeconomic indicators were obtained from the 2015–2019 ACS 5-year estimates at the ZIP Code Tabulation Area (ZCTA) level using _tidycensus_ in R. *Notice: We selected the 2015–2019 estimates because the 2019–2023 ACS data were affected by COVID-19-related disruptions and contained substantial missingness, while SES indicators remain relatively stable over time.

**Data Pre-cleaning and preparation**:

- Extracted valid 5-digit NYC ZIP codes (10001–11697) `zipcode` and padded to valid 5-digit format.

- We focused on variables that are most relevant to restaurant sanitation and the environmental conditions influencing rat activity: 

`zipcode`: zipcodes of the NYC.

`total_pop`: total population of the specific zipcode.

`pov_count`: the subset of individuals living below the U.S. federal poverty threshold as defined by the ACS

`pov_total`: the total civilian population within the ZIP Code Tabulation Area eligible for poverty status determination

`med_income`:the midpoint of the household income distribution where 50% of households earn more and 50% earn less

We also realized that counts describe size and may cause bias (For example, high rodent risk may still exist in smaller-population neighborhoods, and count-based socioeconomic metrics would underestimate such disparities.), but rates and densities describe risk and environment — which are what we want to study. Hence, we created new zip -level variables: 

$pov\_rate = \frac{pov\_count}{pov\_total}$: represents the proportion of residents living below the federal poverty threshold within each ZIP Code Tabulation Area

$population\_density = \frac{total\_pop}{1000}$: expresses the concentration of residents per ZIP code, measured as total population per 1,000 residents, serving as an indicator of urbanization and built environment crowding.

$median\_household\_income = \frac{med\_income}{1000}$: reflects the neighborhood’s economic resource level. med_income denotes the ACS-estimated median household income in USD, scaled per $1,000 for interpretability in modeling and descriptive statistics.

```{r,message=FALSE, warning = FALSE}
rat_fixed <- rat_agg_zip_month_full |>
  mutate(zipcode = as.character(zipcode))

restaurant_fixed <- restaurant_agg_zip_month_full |>
  mutate(zipcode = as.character(zipcode))

ses_fixed <- ses_zip_nyc |>
  mutate(zipcode = as.character(zipcode))

common_zips <- Reduce(
  intersect,
  list(
    rat_fixed$zipcode,
    restaurant_fixed$zipcode,
    ses_fixed$zipcode
  )
)

rat_filtered <- rat_fixed |>
  filter(zipcode %in% common_zips)

restaurant_filtered <- restaurant_fixed |>
  filter(zipcode %in% common_zips)

ses_filtered <- ses_fixed |>
  filter(zipcode %in% common_zips)

df_merged <- rat_filtered |>
  inner_join(restaurant_filtered,
             by = c("zipcode", "year", "month")) |>
  inner_join(ses_filtered,
             by = "zipcode")

write_csv(df_merged, "./data/zip_year_month_merged.csv")
```

## Merge 3 datasets by zipcode x year x month
In the merged dataset, we included variables: `zipcode`, `year`, `month`, `rat_count_zip_month`, `violation_count_zip_month`, `inspection_count_zip_month`, `total_pop`, `poverty_rate`, `population_density`. 

## Export
We exported the merged dataset as csv file zip_year_month_merged.


---
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)

library(tidyverse)
library(lubridate)
library(janitor)
library(sf)
library(tigris)
library(spdep)
library(viridis)
library(patchwork)
library(readr)
library(dplyr)
library(ggplot2)
library(plotly)
library(knitr)
library(kableExtra)

options(tigris_use_cache = TRUE)
```


```{r}
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```



# Spatial Patterns: Seeing Where Rats Live
Before doing any modelling, we want to know whether ZIP codes are a reasonable spatial unit of analysis. Do rat sightings show coherent spatial patterns at the ZIP level, with recognizable “hot” and “cold” areas? Also for  restaurants, do health violations show a similar, spatially structured pattern across ZIP codes, and are the “risky” food environments in the same areas where rat activity is high?
```{r}
df_merged <- readr::read_csv("data/zip_year_month_merged.csv") |>
  janitor::clean_names() |>
  dplyr::mutate(zipcode = as.character(zipcode))

```

```{r make-zip-df}
zip_df <- df_merged |>
  group_by(zipcode) |>
  summarise(
    rat_count_total = sum(rat_count_zip_month, na.rm = TRUE),
    violation_total = sum(violation_count_zip_month, na.rm = TRUE),
    inspection_total = sum(inspection_count_zip_month, na.rm = TRUE),
    total_pop = mean(total_pop, na.rm = TRUE)
  ) |>
  mutate(
    rats_per_10000 = 10000 * rat_count_total / total_pop,
    violations_per_restaurant = violation_total / inspection_total
  ) |>
  filter(
    !is.na(rats_per_10000),
    !is.na(violations_per_restaurant)
  )

```

```{r}
ny_zcta <- tigris::zctas(state = "NY", year = 2010) |>
  dplyr::rename(zipcode = ZCTA5CE10) |>
  dplyr::mutate(zipcode = as.character(zipcode))  

ny_zip_sf <- ny_zcta |>
  dplyr::left_join(zip_df, by = "zipcode") |>
  dplyr::filter(!is.na(violations_per_restaurant)) |>
  sf::st_transform(2263)  

```

### Rat Sightings per 10,000 Residents
The map shows strong spatial variation in rat sightings per 10,000 residents. Staten Island and much of far-eastern Queens appear as clear “cold spots” with relatively few rat complaints. In contrast, several ZIP codes in central and northern Brooklyn and parts of the Bronx stand out as “hot spots” with very high rat sighting rates. Manhattan shows a mixed picture: midtown and some dense residential areas have elevated rates, while a few upper-Manhattan ZIP codes are more moderate.
These gradients suggest that ZIP-level variation is not random noise: neighboring ZIPs often share similar levels, and large, contiguous high-burden and low-burden areas are visible. This supports using ZIP code as the unit of analysis for subsequent spatial and spatio-temporal work.
```{r map-rats}
ggplot(ny_zip_sf, aes(fill = rats_per_10000)) +
  geom_sf(color = "white", size = 0.1) +
  scale_fill_viridis_c(option = "C") +
  labs(
    title = "Rat Sightings per 10,000 Residents (2019–2024)",
    fill  = "Rats / 10,000"
  ) +
  theme_minimal()
```

### Violations per Restaurant
Violations per restaurant also vary systematically by location. Staten Island and some lower-density parts of Brooklyn and Queens tend to have lower violation rates, while several ZIP codes in northern Brooklyn, western Queens, and portions of Manhattan display higher average violations per restaurant. The pattern is not identical to rat activity: some areas with high violation rates do not have the highest rat complaint rates, and vice versa.
```{r map-viol}
ggplot(ny_zip_sf, aes(fill = violations_per_restaurant)) +
  geom_sf(color = "white", size = 0.1) +
  scale_fill_viridis_c(option = "C") +
  labs(
    title = "Violations per Restaurant (2019–2024)",
    fill  = "Violations / Inspection"
  ) +
  theme_minimal()
```

Overall, both outcomes show meaningful spatial structure at the ZIP level, confirming that ZIP codes are a workable unit for analyzing neighborhood-level food environment and rodent burden.



## Are Hotspots Really Clustering? 
In the Local Moran’s I maps, each ZIP code is classified into one of four cluster types based on its own value and the average of its neighbors:

- **High–High:** ZIP codes with high values surrounded by neighbors that also have high values. 

- **Low–Low:** ZIP codes with low values surrounded by low-value neighbors.

- **High–Low:** ZIP codes with high values surrounded by low-value neighbors. These are potential spatial outliers that stand out from a low-value area.

- **Low–High:** ZIP codes with low values surrounded by high-value neighbors. These are the opposite type of spatial outlier.

```{r lisa-weights}
nb <- spdep::poly2nb(ny_zip_sf)
lw <- spdep::nb2listw(nb, style = "W", zero.policy = TRUE)

```

### Local Moran’s I Clusters for Rat Sightings per 10,000 Residents
```{r lisa-rats}
rats_lisa <- spdep::localmoran(
  ny_zip_sf$rats_per_10000,
  lw,
  zero.policy = TRUE
)

rats_lisa_df <- as.data.frame(rats_lisa)

ny_zip_sf <- ny_zip_sf |>
  dplyr::mutate(
    rats_I    = rats_lisa_df$Ii,          
    rats_p    = rats_lisa_df[[ncol(rats_lisa_df)]],  
    rats_mean = mean(rats_per_10000, na.rm = TRUE),
    rats_centered = rats_per_10000 - rats_mean,
    rats_lag  = spdep::lag.listw(lw, rats_per_10000, zero.policy = TRUE),

    rats_quad = dplyr::case_when(
      rats_centered > 0 & rats_lag > 0 & rats_p <= 0.05 ~ "High-High",
      rats_centered < 0 & rats_lag < 0 & rats_p <= 0.05 ~ "Low-Low",
      rats_centered > 0 & rats_lag < 0 & rats_p <= 0.05 ~ "High-Low",
      rats_centered < 0 & rats_lag > 0 & rats_p <= 0.05 ~ "Low-High",
      TRUE ~ "Not significant"
    )
  )

```

For rat sightings, High–High clusters appear in several contiguous ZIP codes in central Brooklyn and parts of the Bronx, indicating true neighborhood-level hotspots rather than single noisy ZIP codes. Low–Low clusters are concentrated in Staten Island and some peripheral ZIPs in Queens, reinforcing the idea of structurally lower rat burden in those areas. A few High–Low or Low–High ZIPs sit on the edges of these clusters, suggesting transition zones where rat activity is changing or where local conditions differ from the broader neighborhood context.
```{r map-lisa-rats}
cluster_cols <- c(
  "High-High"       = "#b2182b",
  "Low-Low"         = "#2166ac",
  "High-Low"        = "#ef8a62",
  "Low-High"        = "#67a9cf",
  "Not significant" = "grey90"
)

ggplot2::ggplot(ny_zip_sf, ggplot2::aes(fill = rats_quad)) +
  ggplot2::geom_sf(color = "white", size = 0.1) +
  ggplot2::scale_fill_manual(values = cluster_cols) +
  ggplot2::labs(
    title = "Local Moran's I Clusters for Rat Sightings per 10,000 Residents",
    fill  = "Cluster"
  ) +
  ggplot2::theme_minimal()
```

### Local Moran’s I Clusters for Violations per Restaurant
```{r lisa-viol}
viol_lisa <- spdep::localmoran(
  ny_zip_sf$violations_per_restaurant,
  lw,
  zero.policy = TRUE
)

viol_lisa_df <- as.data.frame(viol_lisa)

ny_zip_sf <- ny_zip_sf |>
  dplyr::mutate(
    viol_I   = viol_lisa_df$Ii,
    viol_p   = viol_lisa_df[[ncol(viol_lisa_df)]],
    viol_mean = mean(violations_per_restaurant, na.rm = TRUE),
    viol_centered = violations_per_restaurant - viol_mean,
    viol_lag = spdep::lag.listw(lw, violations_per_restaurant, zero.policy = TRUE),

    viol_quad = dplyr::case_when(
      viol_centered > 0 & viol_lag > 0 & viol_p <= 0.05 ~ "High-High",
      viol_centered < 0 & viol_lag < 0 & viol_p <= 0.05 ~ "Low-Low",
      viol_centered > 0 & viol_lag < 0 & viol_p <= 0.05 ~ "High-Low",
      viol_centered < 0 & viol_lag > 0 & viol_p <= 0.05 ~ "Low-High",
      TRUE ~ "Not significant"
    )
  )
```
For violations per restaurant, High–High clusters appear in several ZIP codes in parts of northern Brooklyn and western Queens, as well as a few ZIPs in Manhattan. These areas represent dense restaurant corridors where many establishments have above-average violation rates and are surrounded by similarly high-violation neighbors. Low–Low clusters are again found in much of Staten Island and some lower-density fringe ZIPs, where restaurants tend to have fewer violations and neighboring areas share this profile.

The overlap between rat High–High clusters and violation High–High clusters is partial but not complete. This suggests that while poor restaurant conditions may contribute to rodent problems, rat burden is also shaped by other factors such as housing quality, building age, waste management, and overall neighborhood density.
```{r}
cluster_cols <- c(
  "High-High"       = "#b2182b",
  "Low-Low"         = "#2166ac",
  "High-Low"        = "#ef8a62",
  "Low-High"        = "#67a9cf",
  "Not significant" = "grey90"
)

ggplot2::ggplot(ny_zip_sf, ggplot2::aes(fill = viol_quad)) +
  ggplot2::geom_sf(color = "white", size = 0.1) +
  ggplot2::scale_fill_manual(values = cluster_cols) +
  ggplot2::labs(
    title = "Local Moran's I Clusters for Violations per Restaurant",
    fill  = "Cluster"
  ) +
  ggplot2::theme_minimal()
```

Please see our interactive map: 

<iframe 
  src="https://zihanxiong.shinyapps.io/p8105_final_project_v2/" 
  width="100%" 
  height="700px" 
  frameborder="0" 
  style="border: 1px solid #ccc; border-radius: 5px;"
  title="Interactive EDA Shiny Application">
</iframe>

## Bivariate Hotspots for Rats Sighting and Violations
### Rat Sightings per 10,000 × Violations per Restaurant
- **Double-burden areas** (high rats, high violations):
Several central and northern Brooklyn ZIPs and parts of the Bronx fall into the highest category for both measures. These are neighborhoods where residents are simultaneously exposed to poor restaurant hygiene and high rodent activity. The color gradient suggests these hotspots are not isolated; similar colors extend into adjacent ZIPs, indicating a spatial diffusion pattern rather than a single problematic block.

- **Low-burden areas** (low rats, low violations):
Much of Staten Island and portions of eastern Queens cluster in the bottom-left part of the bivariate legend. These areas likely have lower population and restaurant density, more single-family housing, and possibly better waste management, all of which can reduce both violations and rat sightings.

- **High rats, relatively low violations** (rat-high / restaurant-low):
Some ZIPs near double-burden hotspots show high rat sightings but only moderate or low restaurant violations. One plausible explanation is that these neighborhoods may have fewer restaurants but are adjacent to high-density commercial areas; rats can travel from nearby hotspots via connected sewers, alleys, and transit corridors, even if local restaurants are not the main driver.

- **High violations, relatively low rats** (restaurant-high / rat-low):
In contrast, a few ZIPs with many restaurants and elevated violation rates do not yet show the highest rat complaint rates. These may be emerging risk areas where poor restaurant hygiene has not yet translated into widespread community rat complaints, or where other environmental conditions (e.g., newer building stock, less underground infrastructure, more aggressive pest control) are temporarily buffering rat populations.

```{r}
ny_zip_sf <- ny_zip_sf |>
  dplyr::mutate(
    viol_tertile = dplyr::ntile(violations_per_restaurant, 3),
    rats_tertile = dplyr::ntile(rats_per_10000, 3),
    bi_code = dplyr::if_else(
      is.na(viol_tertile) | is.na(rats_tertile),
      NA_character_,
      paste0("V", viol_tertile, "R", rats_tertile)
    ),
    bi_numeric = dplyr::if_else(
      is.na(viol_tertile) | is.na(rats_tertile),
      NA_integer_,
      (viol_tertile - 1) * 3 + rats_tertile
    )
  )

bi_cols <- viridis::cividis(9)
names(bi_cols) <- as.character(1:9)

p_map <- ggplot2::ggplot(ny_zip_sf, ggplot2::aes(fill = factor(bi_numeric))) +
  ggplot2::geom_sf(color = "white", size = 0.1) +
  ggplot2::scale_fill_manual(
    values = bi_cols,
    na.value = "grey90",
    guide = "none"
  ) +
  ggplot2::labs(
    title = "Bivariate Map: Rat Sightings per 10,000 × Violations per Restaurant"
  ) +
  ggplot2::theme_minimal()

legend_df <- tidyr::expand_grid(
  viol_tertile = 1:3,
  rats_tertile = 1:3
) |>
  dplyr::mutate(
    bi_numeric = (viol_tertile - 1) * 3 + rats_tertile,
    x = viol_tertile,
    y = rats_tertile
  )

p_legend <- ggplot2::ggplot(legend_df, ggplot2::aes(x, y, fill = factor(bi_numeric))) +
  ggplot2::geom_tile(color = "white") +
  ggplot2::scale_fill_manual(values = bi_cols, guide = "none") +
  ggplot2::scale_x_continuous(
    breaks = c(1, 3),
    labels = c("Low", "High"),
    expand = c(0, 0)
  ) +
  ggplot2::scale_y_continuous(
    breaks = c(1, 3),
    labels = c("Low", "High"),
    expand = c(0, 0)
  ) +
  ggplot2::labs(
    x = "Violations per Restaurant",
    y = "Rat Sightings per 10,000"
  ) +
  ggplot2::coord_equal() +
  ggplot2::theme_minimal(base_size = 9)

(p_map | p_legend) +
  patchwork::plot_layout(widths = c(4, 0.8))

```



# Rat Sighting Temporal Exploration

Next, we aim to examine whether there are temporal trends in rat sighting. Specifically, we explore potential seasonal patterns as well as differences across months and years. For this analysis, we use the cleaned merged dataset at the ZIP code × year × month level.

```{r,message = FALSE, warning = FALSE}
rat=read_csv("./data/zip_year_month_merged.csv")|>
  mutate(month=as.integer(month)) |>
  group_by(year, month) |>
  summarise(rat_count_month = sum(rat_count_zip_month, na.rm = TRUE),.groups = "drop") |>
  arrange(year, month) |>
  mutate(
    month_label=month.abb[month],
    month_label=factor(month_label, levels = month.abb)
  ) 
```


### Monthly Rat Sightings in NYC (2019–2024)
**First**, we examined the monthly total number of rat sightings from 2019 to 2024. The line plot clearly reveals a **distinct seasonal pattern**: rat sightings typically rise from spring into late summer (May–September), peak around July–August, and drop sharply during winter months. This pattern is likely driven by seasonal environmental factors such as temperature, food availability, and increased outdoor human activity (reference1).

**Second**, there are noticeable **year-to-year differences**, particularly around the COVID-19 pandemic period. Counts in 2020 are substantially lower, which may reflect reduced human activity during lockdown (e.g., fewer restaurant operations, less outdoor waste, and lower reporting frequency). However, beginning in 2021, sightings rebounded quickly and reached the highest peak in summer 2022 (approximately 3000 reports). This suggests a potential increasing long-term trend in rat activity, possibly related to environmental changes or differences in municipal control strategies.

```{r,message = FALSE, warning = FALSE}
plot_ly(
  rat,
  x = ~month_label,
  y = ~rat_count_month,
  color = ~factor(year),
  type = 'scatter',
  mode = 'lines+markers'
  ) |>
  layout(
    xaxis = list(title = "Month"),
    yaxis = list(title = "Rat Sightings Count")
  )

```
### Distribution of Monthly Rat Sightings per ZIP

At the same time, we considered another important question: What does the distribution of NYC ZIP–Month rat sightings look like? Are there substantial differences across geographic areas? How many ZIP–Month observations report zero or very low counts, and how many approach the higher end of the range?

The histogram of ZIP–Month rat sightings shows that **most ZIP–Month combinations have very low rat counts**, with only a small proportion exhibiting high values. This results in a **highly right-skewed distribution**, indicating that rat activity is spatially **concentrated** and that a handful of ZIP areas represent outliers with disproportionately high sightings.
```{r, include = FALSE, message = FALSE, warning = FALSE}
rat1=read_csv("./data/zip_year_month_merged.csv") 
```

```{r, message = FALSE, warning = FALSE}
plot_ly(
  rat1,
    x = ~rat_count_zip_month,
    type = "histogram",
    nbinsx = 60,  
    marker = list(color = 'rgba(55, 55, 55, 0.8)')
  ) |>
  layout(
    xaxis = list(title = "Rat Sightings (ZIP-Month)"),
    yaxis = list(title = "Number of ZIP-Month Observations"),
    bargap = 0.05
  )
```

Rat sightings count also shows strong overdispersion: the variance (156.4) is far greater than the mean (10.2).
```{r, message = FALSE, warning = FALSE}

rat_stats <- data.frame(
  Statistic = c("Mean of Monthly Rat Sightings", "Variance of Monthly Rat Sightings"),
  Value = c(mean(rat1$rat_count_zip_month), var(rat1$rat_count_zip_month))
)

kable(rat_stats)
```

## NYC Restaurants Inspection Results Temporal Exploration 
While examining the temporal trend of rat sightings, we also investigated whether overall restaurant sanitation levels in NYC changed over time from 2019 to 2024. To represent area-level sanitation in a simple yet meaningful way, we calculated a proxy variable, `violation_rate`, defined as:
$$
\text{violation_rate} = \frac{\text{violation_count_zip_month}}{\text{inspection_count_zip_month}}
$$

This rate reflects the proportion of inspections that resulted in at least one violation within each ZIP–Month unit.

<small>
*Note: To ensure temporal alignment with the rat sighting dataset, the restaurant data were filtered to the same 2019–2024 period. During data cleaning, we observed notable missingness in 2020–2021, likely due to COVID-19 shutdowns affecting restaurant operations and inspections. However, we retained these missing values to preserve data integrity and because they provide important context for interpretation and modeling.*
</small>

```{r,message = FALSE, warning = FALSE}
rest=read_csv("./data/zip_year_month_merged.csv") |>
  group_by(year, month) |>
  summarise(
    total_violations = sum(violation_count_zip_month, na.rm = TRUE),
    total_inspections = sum(inspection_count_zip_month, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(
    violation_rate = if_else(total_inspections > 0,
                             total_violations / total_inspections,
                             NA_real_),
    month_label = factor(
      month,
      levels = 1:12,
      labels = month.abb
    )
  )

```

### Monthly Restaurant Violation Rate in NYC (2019–2024)

Similarly to rat sighting trends, we examined whether overall restaurant sanitation levels show seasonal patterns. We found that the seasonal variation in violation rates is much **less pronounced** compared to rats, and differences across years are relatively **small** (excluding the pandemic-affected months in 2020–2021, most monthly violation rates remain between 3.0 and 3.6). Violation levels in 2022–2024 appear slightly higher than pre-pandemic years. Overall, this suggests that restaurant sanitation conditions may be more influenced by inspection practices and regulatory enforcement rather than environmental seasonality.

```{r,message = FALSE, warning = FALSE}
plot_ly(
  rest,
  x = ~month_label,
  y = ~violation_rate,
  color = ~factor(year),
  type = 'scatter',
  mode = 'lines+markers'
) |>
  layout(
    xaxis = list(title = "Month"),
    yaxis = list(title = "Violation Rate")
  )
```

**In summary, the temporal analysis offers meaningful guidance for our modeling strategy:**

1. Rat sighting activity fluctuates much more noticeably over time compared to restaurant violation rates. This suggests that rats are strongly influenced by environmental and seasonal conditions, while restaurant sanitation is likely just one part of a broader set of contributing factors. Future work may benefit from exploring additional environmental variables.

2. Time clearly plays an important role. Including **Month** and **Year** as fixed effects will help capture both seasonal patterns and year-to-year changes (such as the pandemic dip), leading to more reliable estimates of the relationship between restaurant-related risks and rat activity.



# What Neighborhood Factors Shape Rats and Restaurant Sanitation
This exploratory analysis uses the merged ZIP–year–month dataset to examine whether three socioeconomic variables:
- **poverty_rate**
- **population_density**
- **median_household_income**

are associated with the outcome:
- **rat_count_zip_month**

and the exposure:
- **violation_rate_per_inspection = violation_count_zip_month / inspection_count_zip_month** 

The goal is to determine which SES variables should be included as covariates in the final regression model.


```{r load}
dat <- read_csv("data/zip_year_month_merged.csv") %>%
  clean_names()
```

```{r compute-exposure}
dat <- dat %>%
  mutate(
    violation_rate_per_inspection =
      if_else(inspection_count_zip_month > 0,
              violation_count_zip_month / inspection_count_zip_month,
              NA_real_)
  )

```

## How Exploring SES Landscapes for Rat Sighting
```{r ses-distribution}
dat %>%
  select(poverty_rate, population_density, median_household_income) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30, alpha = 0.7) +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal()
```

The SES variables show substantial variation across ZIP codes in New York City. Poverty rate exhibits a right-skewed distribution, indicating that while many ZIP codes have relatively low poverty, a considerable number experience markedly higher poverty levels. Population density varies dramatically across ZIP codes, reflecting known differences between outer-borough residential zones and the densely populated core of Manhattan. Median household income shows a long right tail, as several ZIP codes include affluent neighborhoods with income levels far above the citywide median. These distributions demonstrate that SES indicators in the data contain sufficient variability to meaningfully examine their associations with rat sightings and restaurant violations.


## Do Socioeconomic Conditions Align With Rats and Violations

```{r correlations}
corr_data <- dat %>%
  select(
    rat_count_zip_month,
    violation_rate_per_inspection,
    poverty_rate,
    population_density,
    median_household_income
  )

cor_matrix <- cor(corr_data, use = "pairwise.complete.obs")

cor_table <- cor_matrix %>%
  round(2) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("Variable")

nice_names <- c(
  "Variable",
  "Rat count / month",
  "Violations / inspection",
  "Poverty rate",
  "Population density",
  "Median HH income"
)
```

```{r}
cor_table %>%
  kable(
    caption = "Correlation matrix for rat counts, violation rates, and SES variables",
    col.names = nice_names,
    align = "lrrrrr"
  ) %>%
  kable_styling(
    full_width = FALSE,
    bootstrap_options = c("striped", "hover", "condensed"),
    font_size = 12,
    position = "center"
  ) %>%
  scroll_box(width = "100%", height = "300px")
```

Correlation analysis reveals meaningful relationships between SES variables and both the outcome and exposure. Rat sightings are positively correlated with poverty rate and population density, suggesting that poorer or more crowded neighborhoods tend to report more rat activity. Median household income is slightly negatively correlated with rat sightings, implying that wealthier ZIP codes generally experience fewer rat complaints.

Population density exhibits the strongest positive correlation with restaurant violation rates, indicating that dense neighborhoods are more likely to have sanitation issues reflected in inspection outcomes. Poverty rate has a weak positive relationship with the violation rate, while median household income shows a weak negative association with violations.

The SES variables are also correlated with each other. Poverty rate and median household income display a strong negative correlation, while population density is moderately positively correlated with poverty rate. These relationships highlight potential multicollinearity concerns if certain SES variables are included together in later multivariable models.

## SES vs Outcome: Rat Count
Who Gets the Rats? SES Gradients in Rodent Activity
```{r ses-vs-rats}
ggplot(dat, aes(x = poverty_rate, y = rat_count_zip_month)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm") +
  theme_minimal() +
  labs(title = "Rat Count vs Poverty Rate")

ggplot(dat, aes(x = population_density, y = rat_count_zip_month)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm") +
  theme_minimal() +
  labs(title = "Rat Count vs Population Density")

ggplot(dat, aes(x = median_household_income, y = rat_count_zip_month)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm") +
  theme_minimal() +
  labs(title = "Rat Count vs Median Household Income")
```

Each of the SES variables demonstrates a distinct association with rat sighting activity. ZIP codes with higher poverty rates consistently show higher rat sighting counts, which may reflect reduced infrastructure quality, fewer resources for pest control, and greater environmental stress. Population density is also positively associated with rat sightings, likely because denser regions generate greater waste and offer more food sources and nesting sites for rodents. Median household income displays a negative association with rat sightings; higher-income neighborhoods report fewer rat incidents, which may reflect better building maintenance, improved sanitation, and greater access to pest management services.


## SES vs Exposure: Violation Rate per Inspection
Which Neighborhoods Struggle With Restaurant Sanitation?
```{r ses-vs-exposure}
ggplot(dat, aes(x = poverty_rate, y = violation_rate_per_inspection)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm") +
  theme_minimal() +
  labs(title = "Violation Rate per Inspection vs Poverty Rate")

ggplot(dat, aes(x = population_density, y = violation_rate_per_inspection)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm") +
  theme_minimal() +
  labs(title = "Violation Rate per Inspection vs Population Density")

ggplot(dat, aes(x = median_household_income, y = violation_rate_per_inspection)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm") +
  theme_minimal() +
  labs(title = "Violation Rate per Inspection vs Median Household Income")
```
Population density is the SES indicator most strongly associated with the violation rate per inspection. ZIP codes with higher density tend to have higher restaurant violation rates, possibly because dense areas contain more restaurants, higher foot traffic, and environmental pressures that challenge sanitation practices. Poverty rate shows a mild positive trend with violation rates, while median household income shows a mild negative relationship, consistent with socioeconomic patterns observed in the rat sighting analysis.



## SES Predictors That Truly Matter
This exploratory analysis demonstrates that poverty rate and population density are the two socioeconomic indicators most strongly and consistently associated with both monthly rat sighting counts and the violation rate per restaurant inspection across New York City ZIP codes from 2019 to 2024. ZIP codes with higher poverty or greater population density tend to exhibit more rat activity and higher restaurant violation burdens, highlighting these SES factors as important structural characteristics relevant to environmental conditions and sanitation outcomes.

Given their clear relationships with both the outcome and exposure, and their conceptual relevance as neighborhood-level socioeconomic determinants, poverty rate and population density should be included as key covariates in the final regression model. In contrast, median household income should not be included jointly with poverty rate, as the two measures are strongly negatively correlated and would likely introduce multicollinearity, reducing the stability and interpretability of model estimates.


```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(readr)
library(janitor)
library(dplyr)
library(ggplot2)
library(readxl)
library(sf)
library(spdep)
library(tigris)
library(lubridate)
library(MASS)
library(broom)
library(knitr)


```


## Model Objective

We used statistical modeling to examine whether changes in restaurant sanitation conditions are associated with rat sighting over time at the ZIP–month level across New York City.

H0 (null hypothesis): There is no association between violation rate and rat sighting counts at the ZIP–month level.
$$
H_0: \beta_1 = 0 \;\Rightarrow\; IRR = 1
$$

H1 (alternative hypothesis): Higher violation rates are associated with higher rat sighting counts.
$$
H_1: \beta_1 > 0 \;\Rightarrow\; IRR > 1
$$

## Outcome and Predictors

**Outcome** `rat_count_zip_month`: monthly rat sighting count per ZIP code

**Main Exposure**: `violation_rate`: proxy variable in our model to represent restaurant sanitation in zip level, so we created this ratio of violation to inspections within each ZIP code and year-month.
$$
\text{violation_rate} = \frac{\text{violation_count_zip_month}}{\text{inspection_count_zip_month}}
$$
**Covariates**: `population_density` and `poverty_rate`.

**Time controls**: `year` and `month` included as categorical fixed effects to account for seasonal and long-term trends.

## Model Selection

In Temporal Analysis from our EDA, we found that `rat_count_zip_month` exhibit substantial overdispersion (variance >> mean), we used Negative Binomial Regression rather than Poisson regression. Negative binomial regression estimates how predictors influence count events, especially when the data are more variable than expected under a Poisson model.

```{r, message = FALSE, warning = FALSE}

df_merged=read_csv("./data/zip_year_month_merged.csv") 

df_model <- df_merged |>
  # calculate violation rate
  mutate(
    violation_rate = violation_count_zip_month / inspection_count_zip_month,
    violation_rate = ifelse(is.na(violation_rate) |
                            inspection_count_zip_month == 0, 0, violation_rate)
  ) |>

  group_by(zipcode) |>
  arrange(zipcode, year, month) |>
  mutate(
    lag_violation_rate = lag(violation_rate, 1)
  ) |>
  ungroup() |>

  filter(!is.na(lag_violation_rate))

```


## Model Building and Comparison

We estimated four nested negative binomial regression models to progressively evaluate the contribution of sanitation, socioeconomic, and temporal factors. 


### Model 1 - unadjusted model (major effect)
Only restaurant sanitation (current month violation rate)
$$
\log \left(E[Y_{z,t}]\right) =
\beta_0 +
\beta_1 \cdot \text{violation_rate}_{z,t}
$$

```{r, message = FALSE, warning = FALSE}
model1 <- glm.nb(
  rat_count_zip_month ~ 
    violation_rate,
  data = df_model)

model1_results <- tidy(model1, exponentiate = TRUE, conf.int = TRUE) |>
  mutate(
    estimate = round(estimate, 3),
    conf.low = round(conf.low, 3),
    conf.high = round(conf.high, 3),
    p.value = ifelse(p.value < 0.05, "<0.05***", round(p.value, 3))
  ) |>
  rename(
    term = term,
    IRR = estimate,
    `2.5% CI` = conf.low,
    `97.5% CI` = conf.high,
    p.value = p.value
  )

kable(model1_results)
```


```{r, message = FALSE, warning = FALSE}

new_df <- data.frame(
  violation_rate = seq(
    min(df_model$violation_rate),
    max(df_model$violation_rate),
    length.out = 100)
)

pred <- predict(model1, newdata = new_df,
                type = "response", se.fit = TRUE)

new_df <- new_df |> 
  mutate(
    fit = pred$fit,
    lower = fit - 1.96 * pred$se.fit,
    upper = fit + 1.96 * pred$se.fit
  )

ggplot(new_df, aes(x = violation_rate, y = fit)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
  labs(
    title = "Predicted Rat Sightings by Violation Rate",
    x = "Restaurant Violation Rate",
    y = "Predicted Rat Sightings (per ZIP per Month)"
  ) +
  theme_minimal()

```

In Model 1, the incidence rate ratio (IRR) for violation rate is 1.134 (95% CI: 1.121–1.147, p < 0.001), which means that at 5% significant level, every 1-unit in `violation_rate` increasing, rat sightings increase by 13.4% on average.  

Higher restaurant violation rates are associated with substantial increases in rat sightings, indicating that deteriorating sanitation environments may contribute to rat infestations. However, Model 1 does not control for other covariates, and may not overestimate the associaiton. 

### Model 2 - SES - Adjusted

Adding SES predictors
$$
\log \left(E[Y_{z,t}]\right) 
=
\beta_0 
+ \beta_1 \cdot \text{violation_rate}_{z,t}
+ \beta_2 \cdot \text{population_density}_{z}
+ \beta_3 \cdot \text{poverty_rate}_{z}
$$

```{r, message = FALSE, warning = FALSE}
model2 <- glm.nb(
  rat_count_zip_month ~ 
    violation_rate+
    population_density +
    poverty_rate,
  data = df_model)

model2_results <- tidy(model2, exponentiate = TRUE, conf.int = TRUE) |>
  mutate(
    estimate = round(estimate, 3),
    conf.low = round(conf.low, 3),
    conf.high = round(conf.high, 3),
    p.value = ifelse(p.value < 0.001, "<0.001***", round(p.value, 3))
  ) |>
  rename(
    term = term,
    IRR = estimate,
    `2.5% CI` = conf.low,
    `97.5% CI` = conf.high,
    p.value = p.value
  )

kable(model2_results)
```

```{r, message = FALSE, warning = FALSE}

new_df2 <- data.frame(
  violation_rate = seq(
    min(df_model$violation_rate),
    max(df_model$violation_rate),
    length.out = 100
  ),
  population_density = mean(df_model$population_density, na.rm = TRUE),
  poverty_rate = mean(df_model$poverty_rate, na.rm = TRUE)
)

pred2 <- predict(model2, newdata = new_df2, 
                 type = "response", se.fit = TRUE)

new_df2 <- new_df2 |>
  mutate(
    fit = pred2$fit,
    lower = fit - 1.96 * pred2$se.fit,
    upper = fit + 1.96 * pred2$se.fit
  )

ggplot(new_df2, aes(x = violation_rate, y = fit)) +
  geom_line(size = 1.1) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
  labs(
    title = "Adjusted Predicted Rat Sightings by Restaurant Violation Rate",
    subtitle = "Model adjusted for population density and poverty rate",
    x = "Restaurant Violation Rate",
    y = "Predicted Rat Sightings"
  ) +
  theme_minimal()

```

In Model 2, the incidence rate ratio (IRR) for violation rate decreased (1.108) (95% CI: 1.098–1.119, p < 0.001), which means that at 5% significant level, every 1-unit in `violation_rate` increasing, rat sightings increase by 11.08% on average, adjusted by `population_density` and `poverty_rate`. 

We can also notice that the incidence rate ratio (IRR) for population density is 1.026 (95% CI: 1.025–1.027, p < 0.001) and for poverty rate is 7.893 (95% CI: 6.5–9.596, p < 0.001), and both of them are statistically significant, indicating although restaurant violation rate is significant, but SES variables also had impact on rat sightings. 

### Model 3 - Time Controls - Fully Adjusted

Adding Time Controls (`year`2019 and `month`1 are the reference levels)

$$
\log \left(E[Y_{z,t}]\right) 
=
\beta_0 
+ \beta_1 \cdot \text{violation_rate}_{z,t}
+ \beta_2 \cdot \text{population_density}_{z}
+ \beta_3 \cdot \text{poverty_rate}_{z}
+ \gamma_t(\text{month})
+ \delta_t(\text{year})
$$

```{r, message = FALSE, warning = FALSE}
model3 <- glm.nb(
  rat_count_zip_month ~ 
    violation_rate+
    population_density +
    poverty_rate+
    factor(year) +
    factor(month),
  data = df_model)

model3_results <- tidy(model3, exponentiate = TRUE, conf.int = TRUE) |>
  mutate(
    estimate = round(estimate, 3),
    conf.low = round(conf.low, 3),
    conf.high = round(conf.high, 3),
    p.value = ifelse(p.value < 0.001, "<0.001***", round(p.value, 3))
  ) |>
  rename(
    term = term,
    IRR = estimate,
    `2.5% CI` = conf.low,
    `97.5% CI` = conf.high,
    p.value = p.value
  )

kable(model3_results)
```

```{r, message = FALSE, warning = FALSE}

new_df3 <- data.frame(
  violation_rate = seq(
    min(df_model$violation_rate),
    max(df_model$violation_rate),
    length.out = 100
  ),
  population_density = mean(df_model$population_density, na.rm = TRUE),
  poverty_rate = mean(df_model$poverty_rate, na.rm = TRUE),
  year = "2022",  
  month = "6"      
)

pred3 <- predict(model3, newdata = new_df3, 
                 type = "response", se.fit = TRUE)

new_df3 <- new_df3 |>
  mutate(
    fit = pred3$fit,
    lower = fit - 1.96 * pred3$se.fit,
    upper = fit + 1.96 * pred3$se.fit
  )

ggplot(new_df3, aes(x = violation_rate, y = fit)) +
  geom_line(size = 1.1) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.15) +
  labs(
    title = "Fully Adjusted Model",
    subtitle = "Predicted Rat Sightings by Violation Rate\nAdjusted for population density, poverty rate, year & month",
    x = "Restaurant Violation Rate",
    y = "Predicted Rat Sightings"
  ) +
  theme_minimal()

```


In Model 3, the incidence rate ratio (IRR) for violation rate is 1.086 (95% CI: 1.071–1.102, p < 0.001), which means that at 5% significant level, every 1-unit in `violation_rate` increasing, rat sightings increase by 10.71% on average, adjusted by `population_density`, `poverty_rate`, `year`, `month`.

After adjusting for `month` and `year` fixed effects, the association between violation rate and rat sightings remained statistically significant, though slightly attenuated (IRR ≈ 1.086).
Seasonality and long-term trends were evident — sightings peaked in summer months (May–September) and showed a post-pandemic rebound — yet restaurant violations still demonstrated an independent contribution to rat activity.

### Model 4 - lag violation rate - Adjusted
Previous month violations predict current rat activity: we also want to take a look at the lag violation as the primary exposure to avoid reverse causality, so we created a new variable `lag_violation_rate`.
$$
\log \left(E[Y_{z,t}]\right] 
=
\beta_0 
+ \beta_1 \cdot \text{lag_violation_rate}_{z,t}
+ \beta_2 \cdot \text{population_density}_{z}
+ \beta_3 \cdot \text{poverty_rate}_{z}
+ \gamma_t(\text{month})
+ \delta_t(\text{year})
$$
```{r, message = FALSE, warning = FALSE}
model4 <- glm.nb(
  rat_count_zip_month ~ 
    lag_violation_rate+
    population_density +
    poverty_rate+
    factor(year) +
    factor(month),
  data = df_model)

model4_results <- tidy(model4, exponentiate = TRUE, conf.int = TRUE) |>
  mutate(
    estimate = round(estimate, 3),
    conf.low = round(conf.low, 3),
    conf.high = round(conf.high, 3),
    p.value = ifelse(p.value < 0.001, "<0.001***", round(p.value, 3))
  ) |>
  rename(
    term = term,
    IRR = estimate,
    `2.5% CI` = conf.low,
    `97.5% CI` = conf.high,
    p.value = p.value
  )

kable(model4_results)
```

```{r, message = FALSE, warning = FALSE}

new_df4 <- data.frame(
  lag_violation_rate = seq(
    min(df_model$lag_violation_rate),
    max(df_model$lag_violation_rate),
    length.out = 100
  ),
  population_density = mean(df_model$population_density, na.rm = TRUE),
  poverty_rate = mean(df_model$poverty_rate, na.rm = TRUE),
  year = "2022",
  month = "6"
)

pred4 <- predict(model4, newdata = new_df4, 
                 type = "response", se.fit = TRUE)

new_df4 <- new_df4 |>
  mutate(
    fit = pred4$fit,
    lower = fit - 1.96 * pred4$se.fit,
    upper = fit + 1.96 * pred4$se.fit
  )

ggplot(new_df4, aes(x = lag_violation_rate, y = fit)) +
  geom_line(size = 1.1) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.15) +
  labs(
    title = "Lagged Model: Predicted Rat Sightings by Violation Rate (1-month lag)",
    subtitle = "Adjusted for SES, year and month",
    x = "Lagged Restaurant Violation Rate (previous month)",
    y = "Predicted Rat Sightings"
  ) +
  theme_minimal()

```

In Model 4, the incidence rate ratio (IRR) for lag violation rate is 1.086 (95% CI: 1.070–1.102, p < 0.001), which means that at 5% significant level, every 1-unit in `violation_rate` increasing, rat sightings increase by 10.86% on average, adjusted by `population_density`, `poverty_rate`, `year`, `month`.

Using the previous month’s violation rate to predict current rat sightings, lagged violations remained a statistically significant predictor, helping reduce concerns about reverse causality.
This suggests that poor sanitation has a cumulative impact — creating environmental conditions that allow rats to persist and proliferate over time, rather than triggering immediate effects only.

## Model Evaluation

To compare predictive performance across the four negative binomial models, we conducted 100 Monte-Carlo cross-validation repetitions. For each split, models were trained on a random subset of ZIP-month observations and evaluated on unseen data using Root Mean Squared Error (RMSE).

```{r, message = FALSE, warning = FALSE}
library(modelr)
set.seed(123)

cv_df <- crossv_mc(df_model, 100) |>
  mutate(
    train = map(train, as_tibble),
    test  = map(test, as_tibble)
  )

```

```{r, message = FALSE, warning = FALSE}
cv_df <- cv_df |>
  mutate(
    m1 = map(train, \(df) glm.nb(rat_count_zip_month ~ violation_rate, data = df)),
    m2 = map(train, \(df) glm.nb(rat_count_zip_month ~ violation_rate +
                                 population_density + poverty_rate, data = df)),
    m3 = map(train, \(df) glm.nb(rat_count_zip_month ~ violation_rate +
                                 population_density + poverty_rate +
                                 factor(year) + factor(month), data = df)),
    m4 = map(train, \(df) glm.nb(rat_count_zip_month ~ lag_violation_rate +
                                 population_density + poverty_rate +
                                 factor(year) + factor(month), data = df))
  )

```

```{r, message = FALSE, warning = FALSE}
rmse_nb <- function(model, df) {
  pred <- predict(model, newdata=df, type="response")
  sqrt(mean((df$rat_count_zip_month - pred)^2))
}

cv_df <- cv_df |>
  mutate(
    rmse_m1 = map2_dbl(m1, test, rmse_nb),
    rmse_m2 = map2_dbl(m2, test, rmse_nb),
    rmse_m3 = map2_dbl(m3, test, rmse_nb),
    rmse_m4 = map2_dbl(m4, test, rmse_nb),

    aic_m1 = map_dbl(m1, AIC),
    aic_m2 = map_dbl(m2, AIC),
    aic_m3 = map_dbl(m3, AIC),
    aic_m4 = map_dbl(m4, AIC)
  )

```

Model 1 had the highest RMSE values, indicating poorer predictive accuracy. Adding socioeconomic covariates (Model 2) reduced RMSE substantially, while further adding time controls (Model 3) and lagged exposure (Model 4) continued to improve prediction. From the RMSE plot, Model 4 has the lowest and most concentrated RMSE distribution.
This indicates that incorporating a lagged violation rate improves prediction accuracy and model stability.

It suggests that poor sanitation does not trigger rat activity immediately but has a delayed and cumulative impact on infestation risk.
```{r, message = FALSE, warning = FALSE}

cv_df |>
  dplyr::select(starts_with("rmse")) |>
  tidyr::pivot_longer(everything(),
               names_to="model", values_to="rmse",
               names_prefix="rmse_") |>
  mutate(model=factor(model, levels=c("m1","m2","m3","m4"))) |>
  ggplot(aes(x=model, y=rmse)) +
  geom_violin(fill="lightblue") +
  theme_minimal() +
  labs(
    x="Model",
    y="RMSE",
    title="Cross-Validation Performance: RMSE"
  )

```


## Discussion

In this study, we integrated New York City rat sighting reports with restaurant inspection results to investigate the potential association between neighborhood-level restaurant sanitation and rat activity. Our results indicate that monthly rat sightings exhibit a clear seasonal pattern—peaking in warmer months—and show a sustained upward trend in the post-pandemic period. In contrast, restaurant violation rates remain relatively stable over time with smaller fluctuations. This suggests that restaurant sanitation likely represents only one contributing risk component.

Moreover, we observed that the spatial distributions of rat sightings and restaurant violation rates only partially overlap. Some neighborhoods experience high violation rates without the highest rat activity, while others show substantial rat problems despite relatively low violation rates. These findings suggest that rat infestations are shaped by a more complex interplay of factors—such as population density, poverty burden, aging housing stock, and urban infrastructure—beyond restaurant sanitation alone. In addition, the detection of clear hotspot clusters indicates potential spatial spillover of environmental health risks across neighboring ZIP codes.

Further modeling analyses revealed that the best model - lagged (one-month) restaurant violation rate is a statistically significant predictor of rat sightings. This supports a plausible mechanism: poorer sanitation and improper waste handling in restaurants may create more favorable food and habitat conditions for rats, leading to increased activity and sightings in the following month. Additionally, socioeconomic characteristics—such as neighborhood poverty levels and population density—were also significantly associated with rat activity, indicating underlying structural disparities across communities. These findings highlight that rat problems are closely tied not only to local sanitation management but also to broader dimensions of urban infrastructure and public health equity.

The temporal and spatial disparities revealed in this study provide important guidance for urban rodent control strategies. First, the sharp seasonal rise in rat activity during summer suggests that the city should reinforce waste management and inspection efforts in advance of high-risk months, particularly within hotspot ZIP codes. Second, the observed lagged association between restaurant violation rates and rat sightings highlights the value of coordinated environmental health governance—strengthening food sanitation enforcement and improving waste handling practices may help reduce subsequent rodent exposure risks. Furthermore, the socioeconomic patterns observed indicate that rat burdens are disproportionately concentrated in resource-limited communities, underscoring the need to incorporate health equity considerations into municipal pest-control planning.

## Limitations

Despite these meaningful insights, several limitations should be acknowledged. Rat sighting data rely on resident reporting, which may be influenced by behavioral factors such as pandemic-related activity changes or differential awareness across communities, introducing potential reporting bias. In addition, considering of complexicity of this study, violation rate reflects sanitation only at the restaurant level and does not account for broader environmental determinants such as street garbage systems, building age and maintenance, underground infrastructure, or transit corridors, limiting the strength of causal interpretations. Finally, while ZIP–Month aggregation facilitates spatio-temporal modeling, it may mask finer-scale variation; future work could leverage more granular geographic units to refine environmental risk assessment.

</div>


